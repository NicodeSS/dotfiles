{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# chezmoi:run-onchange-hash: {{ .packages.linux | toJson | sha256sum }}

# 允许脚本在 brew bundle 失败时继续执行
set +e

brew bundle --verbose --file=/dev/stdin <<EOF
{{ range .packages.darwin.brew -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.cask -}}
cask {{ . | quote }}
{{ end -}}
EOF

brew_exit_code=$?

# 如果失败，显示友好的消息但不终止脚本
if [ $brew_exit_code -ne 0 ]; then
    echo "Caution: brew bundle installation is not fully succeed."
fi

set -e

# 颜色定义
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 安装 pipx 包
echo "开始安装 pipx 包..."

# 检查 pipx 是否可用
if ! command -v pipx &> /dev/null; then
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}         ⚠️  PIPX 不可用警告  ⚠️         ${NC}"
    echo -e "${RED}========================================${NC}"
    echo -e "${YELLOW}pipx 命令未找到！${NC}"
    echo ""
    echo -e "${BLUE}可能的解决方案:${NC}"
    echo -e "  1. 检查 Homebrew 是否正确安装了 pipx:"
    echo -e "     ${GREEN}brew list pipx${NC}"
    echo ""
    echo -e "  2. 如果未安装，请手动安装:"
    echo -e "     ${GREEN}brew install pipx${NC}"
    echo ""
    echo -e "  3. 确保 PATH 包含 pipx 路径:"
    echo -e "     ${GREEN}pipx ensurepath${NC}"
    echo ""
    echo -e "${YELLOW}跳过 pipx 包安装...${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    exit 0
fi

echo -e "${GREEN}✓ pipx 可用，开始安装 Python 包${NC}"

# 收集要安装的 pipx 包
pipx_packages=()

# 添加 common 包
{{ range .packages.darwin.pip.common -}}
pipx_packages+=("{{ . }}")
{{ end -}}

# 根据系统角色添加特定包
{{- if eq .system "client" }}
{{- range .packages.darwin.pip.client }}
pipx_packages+=("{{ . }}")
{{- end }}
{{- else if eq .system "server" }}
{{- range .packages.darwin.pip.server }}
pipx_packages+=("{{ . }}")
{{- end }}
{{- end }}

if [ ${#pipx_packages[@]} -gt 0 ]; then
    echo -e "${BLUE}安装 pipx 包: ${pipx_packages[*]}${NC}"
    for package in "${pipx_packages[@]}"; do
        echo -e "${GREEN}正在安装 pipx 包: $package${NC}"
        if pipx install "$package"; then
            echo -e "${GREEN}✓ $package 安装成功${NC}"
        else
            echo -e "${RED}✗ 警告: pipx 包 $package 安装失败${NC}"
        fi
    done
else
    echo -e "${YELLOW}没有 pipx 包需要安装${NC}"
fi

echo -e "${GREEN}所有包安装完成！${NC}"

{{ end -}}